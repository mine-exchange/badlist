**BadList** — Сервис для хранения и проверки реквизитов пользователей на предмет их отношения к мошеннической деятельности. 

Система представляет собой интерфейс для управления данными и API сервер для получения информации о рисковых пользователях и добавления новых данных.


# Руководство по использованию интерфейса

## Реквизиты
Основной сущностью в BadList является реквизит. Он может быть одного из трёх типов:
- Аккаунт
- Email
- IP адрес

Базовая логика BadList работает следующим образом: внешняя система делает API запрос, содержащий набор реквизитов и в ответ получает данные, какие реквизиты содержатся в "плохом списке". Также присутствует антифрод модуль, который анализирует реквизиты на основании множества факторов и оценивает степени риска.

### Возможные действия с реквизитами:
- Добавить (кнопкой "добавить" добавляется один реквизит, кнопкой "импорт" — сразу множество).
- Редактировать (может только автор).
- Удалить (может только автор, в противном случае реквизит не удаляется физически, но добавляется в меню "исключения" и не будет активным для исключившего его пользователя. При этом в меню "исключения" есть возможность удалить исключение — вернуть реквизит в работу).
- Переместить множество реквизитов в другую группу (доступно только для авторов реквизитов).

#### Комментарии к реквизиту
Комментарии — важный инструмент взаимодействия различных финансовых сервисов друг с другом. 

Комментарии позволяют наглядно увидеть, какие рисковые активности совершил реквизит по отношению к каждому пользователю BadList (финансовому сервису). К каждому реквизиту один пользователь может добавить один комментарий (комментарии добавляются как через интерфейс так и в случае соответствующей автоматизации через API). Удалить комментарий может только автор.

## Группы (для всех пользователей)

Группы являются способом каталогизировать реквизиты, разложив их "по полочкам". При запросе через API пользователь может указать, какими группами следует ограничить запрос. Например, в конкретном случае его могут интересовать только группа "Мошенники" или только группа "Кардеры".

*Создание и удаление групп доступно администраторам системы, пользователи пользуются заранее созданными администраторами группами. В случае необходимости создания новых групп, администраторы по запросу принимают решение о необходимости создания и реализовывают его.*

Со страницы "Группы" можно, нажав соответствующую пиктограмму действия, попасть в интерфейс импорта в конкретную группу множества реквизитов конкретного типа. Пиктограммы данных действий соответствуют типам реквизитов. 

Каждая группа имеет ID, который может быть "подсмотрен" в интерфейсе списка групп и использован при API запросах (параметры groups и groups_exclude)


## Факторы (для администраторов)

В отличии от строгой проверки наличия реквизитов в плохом списке, риск-факторы являются способ анализа пакета реквизитов на основе различных характеристик. 

Каждый риск-фактор является своеобразным "маячком" проблемности пакета реквизитов, но как правило, одного маячка недостаточно для маркировки пакета как рисковый. Каждый риск-фактор имеет свою оценку в виде дробного числа, например 0.2 (выставляется администратором на каждый риск-фактор). В случае если сумма риск-факторов достигает единицы, считается что данный пакет реквизитов является рисковым. При этом, пользователи API вправе решать самостоятельно, на какой уровень total_risk_score следует реагировать, но мы рекомендуем число "1" и более.

Основной функционал, который требуется администратору для работы с риск-факторами — изменение числа риска по каждому фактору и включение-отключение риск-фактора. 

Риск-факторы бывают двух типов:
- Указанный (stated): Уровень риска назначается в интерфейсе "риск-факторы"
- Внешний (handler): Уровень риска определяется скриптом-обработчиком и не устанавливается в интерфейсе "риск-факторы". 


## Группы  (для администраторов)

До текущего момента в данном руководстве упоминался только один тип групп — **Строгое нахождение реквизита в группе (strict_matching)**. 

Однако, есть и другой тип групп, про который следует сказать — **"Группа используется одним из факторов" (used_by_factors_handler)**. В этом типе фактор риска назначается на саму группу в интерфейсе групп. В таких группах присутствует пиктограммка в виде графика.

На данный момент фактор, который используется в связке с группами — это фактор "Наличие в группе". 

Кроме того, администраторам доступны возможности по удалению, добавлению и переименовыванию групп. 


## Список пропуска для реквизитов (для администраторов)

Для каждого пользователя существует свой список "пропускных" реквизитов. Наша идея в том, что любой реквизит, совпавший с пропускным списком может "восстанавливать репутацию" всего отправленного пакета реквизитов.

Если вы уверены в том, что пользователь не связан с мошеннической деятельностью, вы можете добавить его проверенный реквизит (например, email) в данный список: когда в проверяемом пакете реквизитов окажется любой из реквизитов пропускного списка, в ответе от API, общий для всех реквизитов параметр **"passlisted"** будет равен **true** (иначе **false**). Ваша система, которая подключена к BadList может проверять наличие данного параметра и пропускать весь пакет по данному критерию.

Для удобства, вы можете указать примечание при добавлении реквизита в список пропуска.


# API

## API авторизация
Для авторизации в протоколе API запросов используется пользовательский токен. Он доступен в административном интерфейсе "Пользователи". 
Для генерации API токена для нового пользователя необходимо в редактировании пользовательского аккаунта в поле API токен нажать кнопку "Пересоздать" и сохранить результат.

## PHP клиент
Для удобства работы с API вы можете использовать данный API клиент: https://github.com/MineFinanceGroup/badlist-api-client

## Заголовки для всех API запросов
```json
{
    "Accept": "application/json",
    "Content-Type": "application/json",
    "Authorization": "Bearer {your_token}"
}
```

## Типовой ответ об ошибке для всех запросов:
```json
{
    "success": 0,
    "code": "4xx-5xx",
    "errors": {
      "message": "{error_message}",
      "details": {}
    }
}
```

## Методы API
### Проверка реквизитов на нахождение в "плохом" списке

Для данного метода может использоваться указание конкретных групп/авторов. 
 - [Метод для получения списка групп](https://github.com/MineFinanceGroup/badlist#%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D0%B0-%D0%B3%D1%80%D1%83%D0%BF%D0%BF)
- [Метод для получения списка авторов](https://github.com/MineFinanceGroup/badlist#%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D0%B0-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%BE%D0%B2)

**[GET] /{API_PREFIX}/requisite/**
```
{
    "groups": "{group_id1, group_id2....}", необязательный. Если не указан будут учитываться все группы. Для получения списка групп воспользуйтесь методом [GET] groups
    "groups_exclude": "{group_id1, group_id2....}", необязательный. Реквизиты которые находятся в указанных группах не будут учитываться. Для получения списка групп воспользуйтесь методом [GET] groups
    "authors": "{author_id1, author_id2...., me}", необязательный. Если не указан будут учитываться все авторы. "me" - синоним вашего author_id. Для получения списка авторов воспользуйтесь методом [GET] authors
    "authors_exclude": "{author_id1, author_id2...., me}", необязательный. Реквизиты которые были добавлены указанными авторами не будут учитываться. "me" - синоним вашего author_id. Для получения списка авторов воспользуйтесь методом [GET] authors
    "validate_factors": "true|false", необязательный. Если передано true будет выполнена оценка риск-факторов
    "requisites": [
        {
            "type": "{account|email|ip}",
            "value": "{value}",
            "currency": "одна из валют, поддерживаемая mineaml.com" (Необязательный параметр. Присутствует для пользователей с разрешением "aml-verify", реквизит "type"="account")    
        }
    ],
    "meta": { 
        "amount: "1000.00", необязательный. Используется для проверки риск факторами, например "проверка странных сумм". Для оценки риск-факторов необходимо передать "validate_factors": true.
        "is_max_amount: true, необязательный. Используется для проверки риск факторами. Для оценки риск-факторов необходимо передать "validate_factors": true.
        "is_new_client: true, необязательный. Используется для проверки риск факторами. Для оценки риск-факторов необходимо передать "validate_factors": true.    
    }
}
```

#### Успешный ответ
```
{
    "success": 1,
    "code": 200,
    "data": {
        "status": "{exists|not_exists|partially}",
        "total_risk_score": 0, необязательный. Присутствует если запросе передан "validate_factors": true
        "passlisted": "{true|false}",
        "details": [
            {
                "type": "{account|email|ip}",
                "value": "{value}",
                "status": "{exists|not_exists}",
                "author": "{author_username}",
                "risk_score": 0, необязательный. Присутствует если запросе передан "validate_factors": true
                "group": {
                    "id": "{group_id}",
                    "name": "{name}"
                },
                "comments": [
                    {  
                        "author": "{username}",
                        "text": "{comment_text}"  
                    }
                ],
                "aml": { // Необязательный. Присутствует для пользователей с разрешением "aml-verify", "type"="account" и "currency" = валюта, поддерживаемая mineaml.com
                    "id": "{id}",
                    "tx": "{txid}",
                    "address": "{address}",
                    "status": "{ready|pending|updating|missed|failed|new}",
                    "risk_score": 0.234,
                    "signals": {
                        "atm": 0,
                        "dark_market": 0.002,
                        "dark_service": 0,
                        "exchange_fraudulent": 0,
                        "exchange_mlrisk_high": 0.654,
                        "exchange_mlrisk_low": 0.278,
                        "exchange_mlrisk_moderate": 0.043,
                        "exchange_mlrisk_veryhigh": 0.006,
                        "gambling": 0,
                        "illegal_service": 0,
                        "marketplace": 0,
                        "miner": 0,
                        "mixer": 0,
                        "p2p_exchange_mlrisk_high": 0,
                        "p2p_exchange_mlrisk_low": 0,
                        "payment": 0.015,
                        "ransom": 0,
                        "scam": 0,
                        "stolen_coins": 0,
                        "wallet": 0
                    },
                    "counterparty": {
                        "id": "{id}",    
                        "name": "{name}",    
                        "slug": "{slug}",    
                        "type": "p2p_exchange_mlrisk_high",    
                        "subtype": "{subtype}"    
                    }
                }
            }
        ]
    }
}
```

### Добавление реквизитов в "плохой" список
**[POST] /{API_PREFIX}/requisite/**
```
{
    "requisites": [
        {
            "type": "{account|email|ip}",
            "value": "{value}",
            "comment": "{comment}", (необязательный)
            "group_id": "{group_id}"
        }
    ]
}
```
#### Успешный ответ
```json
{
    "success": 1,
    "code": 200,
    "data": {
        "status": "success",
        "details": [
           {
               "type": "{account|email|ip}",
               "value": "{value}",
               "status": "{exists|added|invalid_data}",
               "author": "{author_username}",
               "group": {
                   "id": "{group_id}",
                   "name": "{name}"
               },
               "comments": [
                   {  
                       "author": "{username}",
                       "text": "{comment_text}"  
                   }
               ]      
           }
        ]  
    }
}
```

### Удаление реквизита из "плохого" списка
**[DELETE] /{API_PREFIX}/requisite/**
```json
{
    "type": "{account|email|ip}",
    "value": "{value}"
}
```
#### Успешный ответ
```json
{
    "success": 1,
    "code": 200,
    "data": [
        {
            "status": "{deleted|excluded}"
        }
    ]
}
```

### Получение списка групп
**[GET] /{API_PREFIX}/groups/**
#### Успешный ответ
```json
{
    "success": 1,
    "code": 200,
    "data": [
        {
            "id": "{group_id}",
            "name": "{group_name}"
        }
  ]
}
```

### Получение списка авторов
**[GET] /{API_PREFIX}/authors/**
#### Успешный ответ
```json
{
    "success": 1,
    "code": 200,
    "data": [
        {
            "id": "{author_id}",
            "name": "{author_name}"
        }
  ]
}
```

### Получение списка "пропускных" реквизитов
**[GET] /{API_PREFIX}/passlist/**
#### Успешный ответ
```json
{
    "success": 1,
    "code": 200,
    "data": [
        {
            "id": "{passlist-id}",
            "type": "{account|email|ip}",
            "value": "{value}",
            "note": "{?note}"
        }
  ]
}
```

### Добавление реквизитов в "пропускной" список
**[POST] /{API_PREFIX}/passlist/**
```
[
    {
        "type": "{account|email|ip}",
        "value": "{value}",
        "note": "{note}" (необязательный)
    }
]
```
#### Успешный ответ
```json
{
    "success": 1,
    "code": 200,
    "data": {
        "status": "success",
        "details": [
           {
               "id": "{passlist-id}",
               "type": "{account|email|ip}",
               "value": "{value}",
               "note": "{?note}",
               "status": "{exists|added|invalid_data}"
           }
        ]  
    }
}
```

### Удаление реквизита из "пропускного" списка
**[DELETE] /{API_PREFIX}/passlist/{id}**
```json
{
    "id": "{passlist-id}"
}
```
#### Успешный ответ
```json
{
    "success": 1,
    "code": 200,
    "data": [
        {
            "status": "deleted"
        }
    ]
}
```

